<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>安全态势总览</title>
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <link rel="stylesheet" href="https://unpkg.com/element-plus/theme-chalk/dark/css-vars.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    [v-cloak] {
      display: none;
    }

    :root {
      --el-card-border-radius: 8px;
    }

    html.dark {
      --el-card-border-color: #1f2937;
    }

    .breath {
      animation: breath 2s ease-in-out infinite;
    }

    @keyframes breath {
      0% {
        transform: scale(1);
        opacity: 1
      }

      50% {
        transform: scale(1.1);
        opacity: .85
      }

      100% {
        transform: scale(1);
        opacity: 1
      }
    }

    .pulse {
      animation: pulse 300ms ease-out 1;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 82, 82, .6)
      }

      100% {
        box-shadow: 0 0 0 12px rgba(255, 82, 82, 0)
      }
    }

    .elev4 {
      box-shadow: 0 8px 24px rgba(2, 6, 23, 0.12);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-weight: 600
    }

    .row-enter {
      animation: slideIn 300ms ease-out 1;
    }

    @keyframes slideIn {
      from {
        transform: translateY(8px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    .sprite {
      width: 18px;
      height: 18px;
      fill: currentColor
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 220px;
      max-width: 240px;
      background: #f8f9fa;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 16px 12px;
      z-index: 40
    }

    .sidebar .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 4px;
      font-weight: 600
    }

    .nav {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .nav a {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 40px;
      border-radius: 8px;
      padding: 0 10px;
      color: #334155;
      text-decoration: none;
      transition: background-color .2s ease, color .2s ease
    }

    .nav a .nav-icon {
      width: 24px;
      height: 24px;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .nav a:hover {
      background: #eef2f7;
      color: #0f172a
    }

    .nav a.active {
      background: #e2e8f0;
      color: #0f172a;
      font-weight: 600
    }

    .main-with-sidebar {
      margin-left: 220px
    }

    .header-with-sidebar {
      margin-left: 220px
    }

    .dark .sidebar {
      background: #0f172a;
      border-right-color: #1f2937
    }

    .dark .nav a {
      color: #cbd5e1
    }

    .dark .nav a:hover {
      background: #1f2937;
      color: #e5e7eb
    }

    .dark .nav a.active {
      background: #1f2937;
      color: #ffffff
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 64px;
        padding: 12px 8px
      }

      .sidebar .brand .label {
        display: none
      }

      .nav a .label {
        display: none
      }

      .main-with-sidebar {
        margin-left: 64px
      }

      .header-with-sidebar {
        margin-left: 64px
      }
    }
  </style>
</head>

<body>
  <div id="app" class="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100" v-cloak>
    <aside class="sidebar">
      <div class="brand">
        <i class="fa-solid fa-gauge nav-icon text-blue-600"></i>
        <span class="label">安全态势总览</span>
      </div>
      <nav class="nav">
        <a href="/index.html"><i class="fa-solid fa-chart-line nav-icon"></i><span class="label">Dashboard</span></a>
        <a href="/upload.html"><i class="fa-solid fa-upload nav-icon"></i><span class="label">上传检测</span></a>
        <a href="/reports.html"><i class="fa-solid fa-file-lines nav-icon"></i><span class="label">检测报告</span></a>
        <a href="/settings.html"><i class="fa-solid fa-gear nav-icon"></i><span class="label">设置</span></a>
      </nav>
    </aside>
    <header
      class="sticky top-0 z-30 h-14 px-6 flex items-center justify-between bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 header-with-sidebar">
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-shield-halved text-blue-600"></i>
        <span class="font-semibold">邮件检测系统</span>
      </div>
      <div class="flex items-center gap-2">
        <el-icon class="text-yellow-500">
          <Sunny />
        </el-icon>
        <el-switch v-model="darkMode" active-text="暗色" inactive-text="浅色" inline-prompt></el-switch>
        <el-icon class="text-sky-500">
          <Moon />
        </el-icon>
      </div>
    </header>

    <main class="p-6 space-y-6 main-with-sidebar">
      <section aria-label="核心指标" class="grid grid-cols-12 gap-4">
        <div class="col-span-12 md:col-span-3">
          <div class="h-[120px] rounded-lg elev4 bg-white dark:bg-slate-900 p-4 flex flex-col justify-between">
            <div class="text-xs text-slate-500">今日总处理量</div>
            <div class="text-2xl font-bold">{{ kpis.todayCount }}</div>
            <div class="text-xs">
              <span :class="kpis.trend>=0 ? 'text-green-600' : 'text-red-600'">
                {{ kpis.trend>=0 ? '↑' : '↓' }} {{ Math.abs(kpis.trend).toFixed(2) }}%
              </span>
            </div>
          </div>
        </div>
        <div class="col-span-12 md:col-span-3">
          <div
            :class="['h-[120px] rounded-lg elev4 bg-white dark:bg-slate-900 p-4 flex flex-col justify-between', kpis.interceptPulse ? 'pulse' : '']">
            <div class="text-xs text-slate-500">高风险拦截</div>
            <div class="text-2xl font-bold text-[#FF5252]">{{ kpis.intercept }}</div>
            <div class="text-xs">拦截率：{{ kpis.interceptRate.toFixed(2) }}%</div>
          </div>
        </div>
        <div class="col-span-12 md:col-span-3">
          <div
            class="h-[120px] rounded-lg elev4 bg-white dark:bg-slate-900 p-4 flex flex-col items-center justify-center relative">
            <div id="avgGauge" class="absolute w-full h-full top-0 left-0"></div>
            <div class="text-sm font-semibold absolute bottom-2">{{ kpis.avgLabel }}</div>
          </div>
        </div>
        <div class="col-span-12 md:col-span-3">
          <div class="h-[120px] rounded-lg elev4 bg-white dark:bg-slate-900 p-4 flex flex-col justify-between">
            <div class="flex items-center gap-2">
              <span :class="['w-3 h-3 rounded-full breath', engine.online ? 'bg-[#8BC34A]' : 'bg-[#FF5722]']"></span>
              <span class="text-xs text-slate-500">AI引擎 {{ engine.online? 'Online' : 'Offline' }}</span>
            </div>
            <div>
              <span :class="latencyClass" class="text-lg font-semibold">{{ engine.latency }}ms</span>
            </div>
          </div>
        </div>
      </section>

      <section aria-label="可视化态势" class="grid grid-cols-12 gap-4">
        <div class="col-span-12 xl:col-span-8">
          <div class="rounded-lg elev4 bg-white dark:bg-slate-900 p-4 h-[400px]">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-medium">风险趋势 (最近10天)</div>
              <el-radio-group v-model="range" size="small">
                <el-radio-button label="24h">24h</el-radio-button>
              </el-radio-group>
            </div>
            <div id="trendChart" class="w-full h-[340px]" @dblclick="resetTrend"></div>
          </div>
        </div>
        <div class="col-span-12 xl:col-span-4">
          <div class="rounded-lg elev4 bg-white dark:bg-slate-900 p-4 h-[400px]">
            <div class="text-sm font-medium mb-2">攻击类型特征</div>
            <div id="radarChart" class="w-full h-[340px]"></div>
          </div>
        </div>
      </section>

      <section aria-label="实时监测流" class="rounded-lg elev4 bg-white dark:bg-slate-900 p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-medium">实时检测日志</div>
          <div class="text-xs text-slate-500">自动刷新</div>
        </div>
        <el-table :data="events.slice().reverse()" height="400" row-class-name="row-enter" size="small" stripe>
          <el-table-column label="时间" width="160">
            <template #default="{row}"><span class="font-mono text-xs">{{ row.time }}</span></template>
          </el-table-column>
          <el-table-column label="来源IP" width="140">
            <template #default="{row}">{{ maskIP(row.src) }}</template>
          </el-table-column>
          <el-table-column label="类型" width="100">
            <template #default="{row}">
              <el-tag size="small" :type="row.type === 'phish' ? 'danger' : 'info'">{{ row.type }}</el-tag>
            </template>
          </el-table-column>
          <el-table-column label="摘要" show-overflow-tooltip>
            <template #default="{row}">{{ row.summary }}</template>
          </el-table-column>
          <el-table-column label="风险分" width="80">
            <template #default="{row}"><span :class="badgeClass(row.risk)" class="badge text-xs">{{ row.risk
                }}</span></template>
          </el-table-column>
        </el-table>
      </section>
    </main>
  </div>

  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/element-plus"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue"></script>
  <script src="https://cdn.staticfile.org/echarts/5.5.0/echarts.min.js"></script>
  <script>
    const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue
    const app = createApp({
      setup() {
        const darkMode = ref(false)
        const kpis = reactive({ todayCount: 0, target: 0, trend: 0, intercept: 0, interceptRate: 0, avg: 0, avgLabel: '' })
        const engine = reactive({ online: true, latency: 0 })
        const range = ref('24h')
        const events = reactive([])

        let trendChartInst = null
        let radarChartInst = null
        let gaugeChartInst = null

        const latencyClass = computed(() => engine.latency < 200 ? 'text-green-600' : (engine.latency <= 500 ? 'text-yellow-500' : 'text-red-600'))
        const badgeClass = (v) => v >= 80 ? 'bg-red-600 text-white' : (v >= 50 ? 'bg-orange-500 text-white' : 'bg-blue-600 text-white')

        const ensureEcharts = () => new Promise((resolve) => {
          if (window.echarts) resolve(window.echarts)
          else setTimeout(() => resolve(window.echarts), 300)
        })

        const maskIP = (ip) => {
          if (!ip) return ''
          const parts = ip.split('.');
          if (parts.length !== 4) return ip;
          return `${parts[0]}.*.${parts[2]}.${parts[3]}`
        }

        const renderAvgGauge = async () => {
          await nextTick(); await ensureEcharts();
          const el = document.getElementById('avgGauge'); if (!el) return;
          const theme = darkMode.value ? 'dark' : null

          if (!gaugeChartInst || gaugeChartInst.getDom() !== el) {
            gaugeChartInst = echarts.getInstanceByDom(el) || echarts.init(el, theme)
          }

          gaugeChartInst.setOption({
            backgroundColor: 'transparent',
            series: [{
              type: 'gauge', startAngle: 180, endAngle: 0, min: 0, max: 100,
              axisLine: { lineStyle: { width: 10 } }, pointer: { show: false },
              progress: { show: true, roundCap: true, width: 10 },
              axisTick: { show: false }, splitLine: { show: false }, axisLabel: { show: false },
              detail: { show: false }, data: [{ value: kpis.avg }]
            }]
          })
        }

        const renderTrend = async () => {
          await nextTick(); await ensureEcharts();
          const el = document.getElementById('trendChart'); if (!el) return;
          const theme = darkMode.value ? 'dark' : null

          if (!trendChartInst || trendChartInst.getDom() !== el) {
            trendChartInst = echarts.getInstanceByDom(el) || echarts.init(el, theme)
          }

          try {
            const r = await fetch('/api/stats');
            const d = await r.json();

            const dates = (d.daily || []).map(x => x.date)
            const counts = (d.daily || []).map(x => x.count)
            const risks = counts.map(c => Math.round(c * 0.15))

            trendChartInst.setOption({
              backgroundColor: 'transparent',
              tooltip: { trigger: 'axis' },
              xAxis: { type: 'category', data: dates },
              yAxis: [{ type: 'value', name: '请求' }, { type: 'value', name: '风险' }],
              series: [
                { type: 'line', name: '请求量', data: counts, smooth: true, areaStyle: { opacity: 0.1 } },
                { type: 'bar', name: '高风险', data: risks, yAxisIndex: 1, itemStyle: { color: '#ef4444' } }
              ]
            });
          } catch { }
        }

        const renderRadar = async () => {
          await nextTick(); await ensureEcharts();
          const el = document.getElementById('radarChart'); if (!el) return;
          const theme = darkMode.value ? 'dark' : null

          if (!radarChartInst || radarChartInst.getDom() !== el) {
            radarChartInst = echarts.getInstanceByDom(el) || echarts.init(el, theme)
          }

          try {
            const r = await fetch('/api/stats');
            const d = await r.json();
            const fa = d.features_avg || {}

            radarChartInst.setOption({
              backgroundColor: 'transparent',
              tooltip: {},
              radar: {
                indicator: [
                  { name: '关键词敏感度', max: 100 }, { name: '恶意链接', max: 100 },
                  { name: '恶意附件', max: 100 }, { name: '社工特征', max: 100 }, { name: '风格异常', max: 100 }
                ]
              },
              series: [{
                type: 'radar',
                data: [{
                  value: [
                    fa.keyword || 0, fa.url || 0, fa.attachment || 0,
                    d.llm_avg?.social_engineering || 0, d.llm_avg?.style_anomaly || 0
                  ],
                  name: '威胁特征均值'
                }]
              }]
            });
          } catch { }
        }

        const loadKpis = async () => {
          try {
            const r = await fetch('/api/stats');
            const d = await r.json();

            const total = d.total || 0;
            const high = (d.levels?.['高'] || 0) + (d.levels?.['危急'] || 0);

            kpis.todayCount = total;
            kpis.intercept = high;
            kpis.interceptRate = total > 0 ? (high / total * 100) : 0;
            kpis.avg = Math.round(d.avg?.risk || 0);
            kpis.avgLabel = kpis.avg < 40 ? '安全' : (kpis.avg < 70 ? '中等' : '高危');

            await renderAvgGauge();
          } catch (e) { console.error(e) }
        }

        const pollEvents = async () => {
          try {
            const r = await fetch('/api/events/latest');
            if (r.ok) {
              const arr = await r.json();
              events.splice(0, events.length, ...arr.map(x => ({
                ...x,
                time: new Date(x.ts).toLocaleTimeString()
              })));
            }
          } catch { }
        }

        const initDark = () => {
          const saved = localStorage.getItem('dark') === '1'
          darkMode.value = saved
          document.documentElement.classList.toggle('dark', saved)
        }

        watch(darkMode, (v) => {
          document.documentElement.classList.toggle('dark', v)
          localStorage.setItem('dark', v ? '1' : '0')
          // 主题切换需要重建实例
          if (trendChartInst) { trendChartInst.dispose(); trendChartInst = null }
          if (radarChartInst) { radarChartInst.dispose(); radarChartInst = null }
          if (gaugeChartInst) { gaugeChartInst.dispose(); gaugeChartInst = null }
          renderTrend(); renderRadar(); renderAvgGauge();
        })

        const resetTrend = () => { if (trendChartInst) trendChartInst.dispatchAction({ type: 'dataZoom', start: 0, end: 100 }) }

        onMounted(async () => {
          initDark()
          await loadKpis()
          renderTrend()
          renderRadar()
          pollEvents()

          setInterval(loadKpis, 10000)
          setInterval(pollEvents, 5000)

          fetch('/api/engine/status').then(r => r.json()).then(d => engine.online = d.online).catch(() => engine.online = false)
          fetch('/api/engine/latency').then(r => r.json()).then(d => engine.latency = d.latency).catch(() => { })

          // 响应式调整
          window.addEventListener('resize', () => {
            if (trendChartInst) trendChartInst.resize()
            if (radarChartInst) radarChartInst.resize()
            if (gaugeChartInst) gaugeChartInst.resize()
          })
        })

        return { darkMode, kpis, engine, range, events, maskIP, latencyClass, badgeClass, resetTrend }
      }
    })

    for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) }
    app.use(ElementPlus)
    app.mount('#app')

      ; (function () {
        const links = document.querySelectorAll('.sidebar .nav a');
        let p = location.pathname.split('/').pop() || 'index.html';
        if (!p.endsWith('.html')) p = p + '.html';
        links.forEach(a => { const href = a.getAttribute('href'); if (href && href.includes('index')) a.classList.add('active') })
      })()
  </script>
</body>

</html>